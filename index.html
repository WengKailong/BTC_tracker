<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BTC 地址追踪工具</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
    h1 { text-align: center; }
    #price-info { text-align: center; margin-bottom: 20px; font-size: 18px; }
    .input-container { text-align: center; margin-bottom: 20px; }
    input { padding: 8px; margin: 5px; }
    button { padding: 8px 12px; margin: 5px; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background-color: #f0f0f0; }
    .green { color: green; }
    .red { color: red; }
    .delete-btn { cursor: pointer; color: red; font-weight: bold; }
    .summary { font-weight: bold; text-align: center; margin-top: 20px; }
  </style>
</head>
<body>

<h1>BTC 地址追踪工具</h1>

<div id="price-info">
  当前 BTC 价格: <span id="btc-price">--</span> USD  
  <br>最后更新时间: <span id="last-updated">--</span>
</div>

<div class="input-container">
  <input type="text" id="btcAddress" placeholder="输入BTC地址">
  <input type="text" id="btcLabel" placeholder="标签（可选）">
  <button onclick="addAddress()">添加地址</button>
  <button onclick="refreshData()">刷新数据</button>
</div>

<table>
  <thead>
    <tr>
      <th>标签</th>
      <th>BTC 地址</th>
      <th>余额 (BTC)</th>
      <th>价值 (USD)</th>
      <th>24h 变化</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody id="address-table"></tbody>
</table>

<div class="summary">
  总 BTC: <span id="total-btc">0</span> BTC  
  &nbsp;|&nbsp; 总价值: <span id="total-usd">0</span> USD
</div>

<hr>

<div class="input-container">
  <input type="email" id="email" placeholder="输入您的邮箱订阅提醒">
  <button onclick="subscribe()">订阅余额变化邮件</button>
</div>

<script>
let btcPrice = 0;
let addresses = JSON.parse(localStorage.getItem("btcAddresses") || "[]");
let history = JSON.parse(localStorage.getItem("btcHistory") || "{}");

async function fetchBTCPrice() {
  const res = await fetch("https://api.coindesk.com/v1/bpi/currentprice/BTC.json");
  const data = await res.json();
  btcPrice = data.bpi.USD.rate_float;
  document.getElementById("btc-price").innerText = btcPrice.toLocaleString();
  document.getElementById("last-updated").innerText = new Date().toLocaleString();
}

async function fetchBalance(address) {
  const res = await fetch(`https://blockchain.info/q/addressbalance/${address}?confirmations=3`);
  const satoshis = await res.text();
  return parseInt(satoshis || "0") / 1e8;
}

async function refreshData() {
  await fetchBTCPrice();

  let totalBTC = 0;
  let totalUSD = 0;
  const tbody = document.getElementById("address-table");
  tbody.innerHTML = "";

  for (let addr of addresses) {
    const balance = await fetchBalance(addr.address);
    const usdValue = balance * btcPrice;
    totalBTC += balance;
    totalUSD += usdValue;

    let changeText = "--";
    if (!history[addr.address]) {
      history[addr.address] = { balance, timestamp: Date.now() };
    } else {
      const oldBalance = history[addr.address].balance;
      const diff = balance - oldBalance;
      const percent = oldBalance === 0 ? 0 : (diff / oldBalance) * 100;
      if (diff > 0) {
        changeText = `<span class="green">+${diff.toFixed(8)} BTC (+${percent.toFixed(2)}%)</span>`;
      } else if (diff < 0) {
        changeText = `<span class="red">${diff.toFixed(8)} BTC (${percent.toFixed(2)}%)</span>`;
      } else {
        changeText = "0";
      }
      if (Date.now() - history[addr.address].timestamp >= 24*60*60*1000) {
        history[addr.address] = { balance, timestamp: Date.now() };
      }
    }

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${addr.label || ""}</td>
      <td>${addr.address}</td>
      <td>${balance.toFixed(8)}</td>
      <td>${usdValue.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})}</td>
      <td>${changeText}</td>
      <td class="delete-btn" onclick="deleteAddress('${addr.address}')">删除</td>
    `;
    tbody.appendChild(row);
  }

  document.getElementById("total-btc").innerText = totalBTC.toFixed(8);
  document.getElementById("total-usd").innerText = totalUSD.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});

  localStorage.setItem("btcAddresses", JSON.stringify(addresses));
  localStorage.setItem("btcHistory", JSON.stringify(history));
}

function addAddress() {
  const address = document.getElementById("btcAddress").value.trim();
  const label = document.getElementById("btcLabel").value.trim();
  if (!address) return alert("请输入BTC地址");

  addresses.push({ address, label });
  document.getElementById("btcAddress").value = "";
  document.getElementById("btcLabel").value = "";
  refreshData();
}

function deleteAddress(addr) {
  addresses = addresses.filter(a => a.address !== addr);
  localStorage.setItem("btcAddresses", JSON.stringify(addresses));
  refreshData();
}

// 订阅功能
async function subscribe() {
  const email = document.getElementById("email").value.trim();
  if (!email || addresses.length === 0) {
    alert("邮箱和至少一个BTC地址必填");
    return;
  }
  try {
    const res = await fetch("/api/subscribe", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        email,
        addresses: addresses.map(a => a.address)
      })
    });
    const result = await res.json();
    alert(result.message || "订阅成功，确认邮件已发送至您的邮箱");
  } catch (err) {
    console.error(err);
    alert("订阅失败，请稍后重试");
  }
}

refreshData();
</script>

</body>
</html>
