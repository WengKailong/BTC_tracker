<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BTC 地址追踪器</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
  body {
    margin: 0;
    font-family: 'Inter', 'PingFang SC', 'Microsoft YaHei', sans-serif;
    background: #f5f7fa;
    color: #333;
  }

  header {
    text-align: center;
    padding: 20px 10px;
    background: white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    position: sticky;
    top: 0;
    z-index: 10;
  }

  header h1 {
    margin: 0;
    font-size: 24px;
  }

  #priceTimestamp {
    margin-top: 6px;
    font-size: 14px;
    color: #666;
  }

  #addForm {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin: 20px auto;
    padding: 20px;
    max-width: 500px;
    background: white;
    border-radius: 16px;
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
  }

  #addForm input,
  #addForm button {
    padding: 12px;
    font-size: 14px;
    border-radius: 8px;
  }

  #addForm input {
    border: 1px solid #ddd;
    outline: none;
    transition: border-color 0.2s ease;
  }

  #addForm input:focus {
    border-color: #4a90e2;
  }

  #addForm button {
    background: #4a90e2;
    color: white;
    border: none;
    cursor: pointer;
    transition: background 0.2s ease;
  }

  #addForm button:hover {
    background: #357ABD;
  }

  #totals {
    text-align: center;
    margin: 15px 0;
    font-size: 16px;
    color: #444;
  }

  #wallets {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 18px;
    padding: 0 10px 40px;
    max-width: 1200px;
    margin: auto;
  }

  .card {
    background: white;
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 4px 14px rgba(0, 0, 0, 0.08);
    display: flex;
    flex-direction: column;
    gap: 10px;
    word-break: break-word;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border-left: 4px solid #4a90e2;
  }

  .card:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
  }

  .card div {
    font-size: 14px;
    color: #444;
    line-height: 1.6;
  }

  .card .balance {
    font-size: 18px;
    font-weight: bold;
    color: #222;
  }

  .card .usd {
    color: #4a90e2;
    font-weight: 500;
  }

  .card .emails {
    font-size: 12px;
    color: #888;
    border-top: 1px solid #eee;
    margin-top: 10px;
    padding-top: 8px;
  }

  canvas {
    max-width: 800px;
    margin: 30px auto 10px;
    display: block;
  }

  @media (max-width: 480px) {
    header h1 {
      font-size: 20px;
    }

    #addForm {
      margin: 10px;
      padding: 16px;
    }

    .card {
      padding: 16px;
    }
  }
</style>

</head>
<body>
  <header>
    <h1>BTC 地址追踪器</h1>
    <div id="priceTimestamp">加载BTC价格中...</div>
  </header>

  <form id="addForm">
    <input type="text" id="btcAddress" placeholder="输入BTC地址" required />
    <input type="email" id="email" placeholder="订阅邮箱（可选）" />
    <button type="submit">添加地址并订阅提醒</button>
  </form>

  <div id="totals">
    总BTC数量: <span id="totalBTC">0</span> BTC &nbsp;|&nbsp; 总价值: $<span id="totalUSD">0</span>
  </div>

  <canvas id="chart"></canvas>

  <div id="wallets"></div>

  <script>
    let btcPrice = 0;
    let addressMap = {}; // { address: { balance, emails: Set([...]) } }

    function maskEmail(email) {
      const [name, domain] = email.split("@");
      if (name.length <= 3) return name[0] + "*".repeat(name.length - 1) + "@" + domain;
      return name.slice(0, 3) + "*".repeat(name.length - 3) + "@" + domain;
    }

    async function fetchSubscribers() {
      const urlSecret = new URLSearchParams(location.search).get("secret");
      if (!urlSecret) {
        alert("无权访问：缺少 secret");
        document.body.innerHTML = "<h2 style='text-align:center;margin-top:40px;'>无权访问</h2>";
        return;
      }
      try {
        const res = await fetch(`/api/get-subscribers?secret=${urlSecret}`);
        if (res.status === 403) {
          document.body.innerHTML = "<h2 style='text-align:center;margin-top:40px;'>无权访问</h2>";
          return;
        }
        const data = await res.json();
        addressMap = {};
        for (const sub of Object.values(data)) {
          const email = sub.email || "未填写邮箱";
          const addresses = sub.addresses || [];
          addresses.forEach(addr => {
            if (!addressMap[addr]) addressMap[addr] = { balance: 0, emails: new Set() };
            if (email !== "未填写邮箱") addressMap[addr].emails.add(email);
          });
        }
        renderWallets();
        updateBalances();
      } catch (err) {
        alert("加载订阅数据失败");
      }
    }

    async function fetchBTCPrice() {
      try {
        const res = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd");
        const data = await res.json();
        btcPrice = data.bitcoin.usd;
        document.getElementById("priceTimestamp").innerText =
          `BTC价格: $${btcPrice.toLocaleString()} (更新: ${new Date().toLocaleTimeString()})`;
        updateTotals();
      } catch (err) {
        console.error("获取BTC价格失败", err);
      }
    }

    async function fetchBalance(address) {
      try {
        const res = await fetch(`https://blockstream.info/api/address/${address}`);
        if (!res.ok) return 0;
        const data = await res.json();
        const satoshi = data.chain_stats.funded_txo_sum - data.chain_stats.spent_txo_sum;
        return satoshi / 1e8;
      } catch {
        return 0;
      }
    }

    function renderWallets() {
      const container = document.getElementById("wallets");
      container.innerHTML = "";
      Object.entries(addressMap).forEach(([addr, info], idx) => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div><strong>地址：</strong>${addr}</div>
          <div class="balance" id="balance-${idx}"><strong>余额：</strong>加载中...</div>
          <div class="usd usdValue" id="usd-${idx}"><strong>价值：</strong>加载中...</div>
          <div class="emails"><strong>订阅邮箱：</strong>${[...info.emails].map(maskEmail).join(", ") || "无"}</div>
        `;
        container.appendChild(card);
      });
    }

    async function updateBalances() {
      let totalBTC = 0;
      const addrs = Object.keys(addressMap);
      for (let i = 0; i < addrs.length; i++) {
        const addr = addrs[i];
        const balance = await fetchBalance(addr);
        addressMap[addr].balance = balance;
        document.getElementById(`balance-${i}`).innerText = `余额: ${balance} BTC`;
        document.getElementById(`usd-${i}`).innerText = `价值: $${(balance * btcPrice).toLocaleString()}`;
        totalBTC += balance;
      }
      document.getElementById("totalBTC").innerText = totalBTC;
      document.getElementById("totalUSD").innerText = (totalBTC * btcPrice).toLocaleString();
    }

    function updateTotals() {
      const totalBTC = Object.values(addressMap).reduce((sum, info) => sum + (info.balance || 0), 0);
      document.getElementById("totalBTC").innerText = totalBTC;
      document.getElementById("totalUSD").innerText = (totalBTC * btcPrice).toLocaleString();
    }

    async function drawHistoryChart() {
      const urlSecret = new URLSearchParams(location.search).get("secret");
      if (!urlSecret) return;
    
      try {
        const res = await fetch(`/api/get-history?secret=${urlSecret}`);
        const { history } = await res.json();
    
        const labels = history.map(i => {
          const date = new Date(i.time);
          return isNaN(date) ? "无效时间" : date.toLocaleString();
        });
        const data = history.map(i => i.totalBTC);
    
        new Chart(document.getElementById("chart"), {
          type: "line",
          data: {
            labels,
            datasets: [{
              label: "总BTC数量变化",
              data,
              borderColor: "#4a90e2",
              backgroundColor: "rgba(74, 144, 226, 0.1)",
              fill: true,
              tension: 0.2,
              pointRadius: 2,
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: true },
              tooltip: { mode: 'index', intersect: false }
            },
            scales: {
              x: {
                ticks: {
                  maxRotation: 60,
                  minRotation: 30,
                  autoSkip: true,
                }
              },
              y: {
                beginAtZero: true,
                title: { display: true, text: 'BTC 总余额' }
              }
            }
          }
        });
      } catch (err) {
        console.error("历史图表加载失败", err);
      }
    }



    document.getElementById("addForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const addr = document.getElementById("btcAddress").value.trim();
      const email = document.getElementById("email").value.trim();
      if (!addr) return alert("BTC地址必填");
      try {
        const res = await fetch("/api/subscribe", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, addresses: [addr] })
        });
        const result = await res.json();
        alert(result.message || "订阅请求已发送");
        await fetchSubscribers();
      } catch {
        alert("订阅请求发送失败");
      }
      document.getElementById("btcAddress").value = "";
      document.getElementById("email").value = "";
    });

    fetchBTCPrice();
    fetchSubscribers();
    drawHistoryChart();
    setInterval(fetchBTCPrice, 60000);
    setInterval(updateBalances, 60000);
  </script>
</body>
</html>
